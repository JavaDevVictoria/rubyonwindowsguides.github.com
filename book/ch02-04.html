<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Devkit</title>
   <meta name="author" content="Boško Ivanišević" />

   <link rel="stylesheet" href="/css/960.css" type="text/css" />
   <link rel="stylesheet" href="/css/reset.css" type="text/css" />
   <link rel="stylesheet" href="/css/text.css" type="text/css" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/style.css" type="text/css" media="screen, projection" />

   <!-- Update your html tag to include the itemscope and itemtype attributes -->
   <html itemscope itemtype="http://schema.org/Book">

   <!-- Add the following three tags inside head -->
   <meta itemprop="name" content="Ruby On Windows Guides">
   <meta itemprop="description" content="Comprehensive guides for Ruby on Windows">

   <!-- Place this render call where appropriate -->
   <script type="text/javascript">
      (function() {
        var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
        po.src = 'https://apis.google.com/js/plusone.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
      })();
   </script>

   <script type="text/javascript">

     var _gaq = _gaq || [];
     _gaq.push(['_setAccount', 'UA-26061460-1']);
     _gaq.push(['_trackPageview']);

     (function() {
     var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
     ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
     var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
     })();

   </script>
</head>
<body>

<div class="container_12">
  <!--<div class="grid_2">
    <br/>
    <h1>Something</h1>
    <p>
      Lorem ipsum, etc, etc, so on and so forth
    </p>
  </div>-->

  <div id="main" class="grid_10">
    <div id="header" class="grid_10">
      <br/>
      <table>
        <tr>
          <td><img src="/images/rwg_logo_blue.png"/></td>
          <td>
            <h1>Ruby on Windows Guides</h1>
            <h4>Comprehensive guides for Ruby on Windows</h4>
            <h6>by Bosko Ivanisevic</h6>
          </td>
        </tr>
      </table>
    </div>

    <div id="menu" class="grid_10">
      <a href="/">Book</a>
      <a href="/about.html">About</a>
      <!-- <a href="/something.html">Something</a> -->
    </div>

    <div id="content" class="grid_10">
      <!-- Place this tag where you want the +1 button to render -->
      <g:plusone annotation="inline"></g:plusone>
      <br/>
      
      <a href="/book/ch02-03.html" title="Previous: Pik">&laquo; Pik</a>
      

      
      &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
      <a href="/book/ch02-05.html" title="Next: Installing Native Gems">Installing Native Gems &raquo; </a>
       
      <br/><br/>

      <p>ause of DevKit malfunction. Finally E-TextEditor, Windows version of TextMate – very popular editor among Ruby on Rails developers, comes with Cygwin which can prevent building native Ruby extensions with the DevKit. Before you go on with DevKit installation check your system.</p>
<p>RubyInstaller&#8217;s DevKit comes with Ruby script that is used to inject it to all Ruby versions you have installed on the system. You will find dk.rb script in <code>C:\Ruby\DevKit</code> directory. Let&#8217;s execute it now and check the output:</p>
<div>
<pre>
<code class='bat'>c:\Ruby\DevKit&amp;gt;ruby dk.rb
<p>Configures an <span class="caps">MSYS</span>/MinGW based Development Kit (DevKit) for<br />
each of the Ruby installations on your Windows system. The<br />
DevKit enables you to build many of the available native<br />
RubyGems that don&#8217;t yet have a binary gem.</p>
<p>Usage: ruby dk.rb <span class="caps">COMMAND</span> [options]</p>
<p>where <span class="caps">COMMAND</span> is one of:</p>
init     prepare DevKit for installation
review   review DevKit install plan
install  install required DevKit executables
<p>and &#8216;install&#8217; [options] are:</p>
-f, &#8212;force  overwrite existing helper scripts</code>
</pre>
</div>
<p>As indicated by the message you have to use one of three commands: <code>init</code>, <code>review</code> and <code>install</code> when you execute script. Moreover commands should be executed in the same order as they are listed in the output.</p>
<p>First command collects data about installed Ruby versions on the system. Goto directory where you have unpacked DevKit (you&#8217;ll see in a moment why) and execute script passing it <code>init</code> command.</p>
<div>
<pre>
<code class='bat'>c:\&amp;gt;cd Ruby\DevKit
<p>c:\Ruby\DevKit&gt;ruby dk.rb init<br />
[<span class="caps">INFO</span>] found RubyInstaller v1.9.2 at c:/Ruby/192</p>
<p>Initialization complete! Please review and modify the auto-generated<br />
&#8216;config.yml&#8217; file to ensure it contains the root directories to all<br />
of the installed Rubies you want enhanced by the DevKit.</code><br />
  </pre></p>
</div>
<p>Script has created <code>config.yml</code> file in the folder from which script was executed. That&#8217;s why we switched to DevKit directory before we started it. As you can see only one Ruby version has been found, and that&#8217;s the one for which we have used installer. As Pik, DevKit searches your system&#8217;s registry for installed Rubies and for each version found, it displays a message and writes necessary data to the configuration file. Here is the code that lies behind this “magic”</p>
<div>
<pre>
<code class='ruby'>def self.scan_for(key)
ris = []
[Win32::Registry::HKEY_LOCAL_MACHINE,
Win32::Registry::HKEY_CURRENT_USER].each do |hive|
begin
hive.open(key) do |ri_key|
ri_key.each_key do |skey, wtime|
<ol>
	<li>read the install location if a version subkey<br />
          if skey =~ /\d\.\d\.\d/<br />
            ri_key.open(skey) do |ver_key|<br />
              ri_root = ver_key[&#8216;InstallLocation&#8217;].gsub(&#8216;\\&#8217;, &#8216;/&#8217;)<br />
              puts &#8216;[<span class="caps">INFO</span>] found RubyInstaller v%s at %s&#8217; % [ skey, ri_root ]<br />
              ris &lt;&lt; ri_root<br />
            end<br />
          end<br />
        end<br />
      end<br />
    rescue Win32::Registry::Error<br />
    end<br />
  end<br />
  ris<br />
end</code><br />
  </pre><br />
</div></li>
</ol>
<p>Script searches key within <code>HKLM</code> (<code>HKEY_LOCAL_MACHINE</code>) and <code>HKCU</code> (<code>HKEY_CURRENT_USER</code>) passed as an argument for sub-key that matches version pattern <code>/\d\.\d\.\d/</code>. This is regular expression that corresponds to three numbers (<code>\d</code>) separated by dots (<code>\.</code>). If it finds one it reads InstallLocation string value and replaces Windows path separator, backslash (<code>'\'</code>), with path separator which is correctly handled by MinGW – forward slash (<code>'/'</code>). Finally it stores path in the array which is returned as a result of the method. Keys that are searched are <code>Software\RubyInstaller\MRI</code> and <code>Software\RubyInstaller\Rubinius</code>. These are only Rubies that are supported by DevKit at the moment. We should see what has been written to the configuration file.</p>
<div>
<pre>
<code class='ruby'># This configuration file contains the absolute path locations of all
<ol>
	<li>installed Rubies to be enhanced to work with the DevKit. This config</li>
	<li>file is generated by the &#8216;ruby dk.rb init&#8217; step and may be modified</li>
	<li>before running the &#8216;ruby dk.rb install&#8217; step. To include any installed</li>
	<li>Rubies that were not automagically discovered, simply add a line below</li>
	<li>the triple hyphens with the absolute path to the Ruby root directory.<br />
#</li>
	<li>Example:<br />
#</li>
	<li><del>-</del></li>
	<li>- C:/ruby19trunk</li>
	<li>- C:/ruby192dev<br />
#<br />
<del>-</del><br />
- c:/Ruby/192</code><br />
  </pre><br />
</div></li>
</ol>
<p>Besides detailed explanation in the comments, script has actually serialized Ruby array with only one element, path to the Ruby version installed with the installer. Does it mean we cannot use DevKit for other Ruby versions we built or just unpacked? Of course not. We may modify this file and manually add all versions we intend to use DevKit with, as long as we follow <span class="caps">YAML</span> specification for serializing arrays.</p>
<p><span class="caps">YAML</span> uses particular sequence of characters for array elements. Each entry begins on its own line and sequences indicates each entry with a dash and space (@- @). Sequence of scalars, as it is stated in the <span class="caps">YAML</span> specification, or entries in the Ruby array is therefore written as:</p>
<div>
<pre>
<code class='ruby'>- Ruby
<p>- is a<br />
- great programming language</code><br />
  </pre></p>
</div>
<p>After parsing it in Ruby this set will result in an Array object with three elements:</p>
<div>
<pre>
<code class='ruby'>[“Ruby”, “is a”, “great programming language”]</code>
</pre>
</div>
<p>With this background we are ready to add Ruby versions that we have on the system. Apart from Ruby 1.9.2p136 we have Ruby 1.8.7p330, Ruby 1.9.3dev and IronRuby. As stated above DevKit supports only <span class="caps">MRI</span> and Rubinius Rubies so we can leave out IronRuby. For each additional version we have on the system we must add one line that starts with a dash-space sequence followed by the full path where it is on the disk. Final version of <code>config.yml</code> file should be (comments omitted):</p>
<div>
<pre>
<code class='ruby'>---
<p>- c:/Ruby/192<br />
- c:/Ruby/187<br />
- c:/Ruby/193dev</code><br />
  </pre></p>
</div>
<p>Next suggested <code>dk.rb</code> command is <code>review</code>. This command will check our configuration file and if it is valid, information will be printed out:</p>
<div>
<pre>
<code class='bat'>c:\Ruby\DevKit&amp;gt;ruby dk.rb review
<p>Based upon the settings in the &#8216;config.yml&#8217; file generated<br />
from running &#8216;ruby dk.rb init&#8217; and any of your customizations,<br />
DevKit functionality will be injected into the following Rubies<br />
when you run &#8216;ruby dk.rb install&#8217;.</p>
<p>C:/Ruby/192<br />
C:/Ruby/187<br />
C:/Ruby/193dev</code><br />
  </pre></p>
</div>
<p>As expected <code>dk.rb</code> has found all Ruby versions we added, beside the one that was original added by init command. It is time to inject DevKit in all listed Ruby versions. Execute script with install command:</p>
<div>
<pre>
<code class='bat'>c:\Ruby\DevKit&amp;gt;ruby dk.rb install
<p>[<span class="caps">INFO</span>] Updating convenience notice gem override for &#8216;C:/Ruby/192&#8217;<br />
[<span class="caps">INFO</span>] Installing &#8216;C:/Ruby/192/lib/ruby/site_ruby/devkit.rb&#8217;<br />
[<span class="caps">INFO</span>] Updating convenience notice gem override for &#8216;C:/Ruby/187&#8217;<br />
[<span class="caps">INFO</span>] Installing &#8216;C:/Ruby/187/lib/ruby/site_ruby/devkit.rb&#8217;<br />
[<span class="caps">INFO</span>] Updating convenience notice gem override for &#8216;C:/Ruby/193dev&#8217;<br />
[<span class="caps">INFO</span>] Installing &#8216;C:/Ruby/193dev/lib/ruby/site_ruby/devkit.rb&#8217;</code><br />
  </pre></p>
</div>
<p>Script has installed <code>devkit.rb</code> file in <code>site_ruby</code> directories in each Ruby version that we added to configuration file. Directory <code>site_ruby</code> has special meaning. This is the place where you want to put Ruby extensions other than those managed by Rubygems. Therefore if you want to extend Ruby without building new gem this is the place where you will put your scripts. You shouldn&#8217;t use it too often. As a matter of act it should be used carefully and only if you really want to add some low-level extension. DevKit is exactly that – low level Ruby extension for Windows operating systems. Without it Ruby on Windows would not be capable to build native gems. So what is actually written in devkit.rb?</p>
<div>
<pre>
<code class='ruby'># enable RubyInstaller DevKit usage as a vendorable helper library
<p>unless <span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;].include?(&#8216;c:\\Ruby\\DevKit\\mingw\\bin&#8217;) then<br />
  puts &#8216;Temporarily enhancing <span class="caps">PATH</span> to include DevKit&#8230;&#8217;<br />
  <span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;] = &#8216;c:\\Ruby\\DevKit\\bin;c:\\Ruby\\DevKit\\mingw\\bin;&#8217; + <span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;]<br />
end<br />
<span class="caps">ENV</span>[&#8216;RI_DEVKIT&#8217;] = &#8216;c:\\Ruby\\DevKit&#8217;<br />
<span class="caps">ENV</span>[&#8216;CC&#8217;] = &#8216;gcc&#8217;<br />
<span class="caps">ENV</span>[&#8216;<span class="caps">CPP</span>&#8217;] = &#8216;cpp&#8217;<br />
<span class="caps">ENV</span>[&#8216;<span class="caps">CXX</span>&#8217;] = &#8216;g++&#8217;</code><br />
  </pre></p>
</div>
<p>Script first checks whether our DevKit is in the path. If it is not, it prints out informational message and adds necessary directories at the beginning of the path so they are very first directories searched for the executable files after directory from which executable is invoked. In other words if some Ruby, script tries to execute for example gcc, g++ or some other <span class="caps">MSYS</span>/MinGW executable and if it is not found in the current executing directory, first paths where they will be looked for are our DevKit directories. Besides it sets few environment variables needed for building native gems. Very clever solution, isn&#8217;t it? We do not have to have these directories in the path all the time. When needed they will be added.</p>
<p>DevKit&#8217;s <code>dk.rb</code> script has printed out one more type of message though. This was <code>[INFO] Updating convenience notice gem override for &lt;ruby_version&gt;</code>. Script has obviously updated something so let&#8217;s check what. The relevant part of code in <code>dk.rb</code> is:</p>
<div>
<pre>
<code class='ruby'>target_ruby.each do |folder|
target = File.join(folder, &#8216;defaults&#8217;, &#8216;operating_system.rb&#8217;)
FileUtils.mkdir_p File.dirname(target)
if File.exist?(target)
content = File.read(target)
case
when content !~ /^#.*DevKit/o
<ol>
	<li>handle original and new token-based comments<br />
      puts &quot;[<span class="caps">INFO</span>] Updating existing gem override for &#8216;#{path}&#8217;&quot;<br />
      File.open(target, &#8216;a&#8217;) { |f| f.write(gem_override) }<br />
    when content =~ /^# #{DEVKIT_START} missing DevKit/o</li>
	<li>replace missing DevKit/build tool convenience notice<br />
      puts &quot;[<span class="caps">INFO</span>] Updating convenience notice gem override for &#8216;#{path}&#8217;&quot;<br />
      update_gem_override(target)<br />
    else<br />
      puts &quot;[<span class="caps">INFO</span>] Skipping existing gem override for &#8216;#{path}&#8217;&quot; unless $options[:force]</li>
</ol>
if $options[:force]
puts &quot;[<span class="caps">WARN</span>] Updating (with backup) existing gem override for &#8216;#{path}&#8217;&quot;
update_gem_override(target)
end
end
else
puts &quot;[<span class="caps">INFO</span>] Installing &#8216;#{target}&#8217;&quot;
File.open(target, &#8216;w&#8217;) { |f| f.write(gem_override) }
end
<p>end</code><br />
  </pre></p>
</div>
<p>Without going in too much details, what can be seen from the code is that script is looking for <code>operating_system.rb</code> file in some directories. Depending whether it has found old versions of the file, it updates them and if <code>operating_system.rb</code> file is not found at all it will create new one if it is forced by passing <code>--force</code> argument to install command. The <code>operating_system.rb</code> file is bundled with all RubyInstaller versions and they alter a way Rubygems install gems. Content of newly created, or updated, <code>operating_system.rb</code> file is:</p>
<div>
<pre>
<code class='ruby'>Gem.pre_install do |gem_installer|
unless gem_installer.spec.extensions.empty?
unless <span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;].include?(&#8216;c:\\Ruby\\DevKit\\mingw\\bin&#8217;) then
Gem.ui.say &#8216;Temporarily enhancing <span class="caps">PATH</span> to include DevKit&#8230;&#8217;
if Gem.configuration.verbose
<span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;] = &#8216;c:\\Ruby\\DevKit\\bin;c:\\Ruby\\DevKit\\mingw\\bin;&#8217; + <span class="caps">ENV</span>[&#8216;<span class="caps">PATH</span>&#8217;]
end
<span class="caps">ENV</span>[&#8216;RI_DEVKIT&#8217;] = &#8216;c:\\Ruby\\DevKit&#8217;
<span class="caps">ENV</span>[&#8216;CC&#8217;] = &#8216;gcc&#8217;
<span class="caps">ENV</span>[&#8216;<span class="caps">CPP</span>&#8217;] = &#8216;cpp&#8217;
<span class="caps">ENV</span>[&#8216;<span class="caps">CXX</span>&#8217;] = &#8216;g++&#8217;
end
<p>end</code><br />
  </pre></p>
</div>
<p>The code calls singleton method <code>pre_install</code> of Gem module and passes it a block. This method is actually a hook that will be called prior to any gem installation. It accepts a block of code, converts it to Proc object and adds it to the list of procedures that will be called before any gem is installed.</p>
<p>Block passed to the pre-install hook checks whether gem has native extensions. If it has, it further checks for tools essential for building them. These tools are compiler (gcc), shell script (sh) and make. For each of them script executes simple shell command and if it was successfully finished it does nothing. Otherwise it informs us that we need build tools and where to get them. It is strongly recommended to run so called smoke test and check if DevKit works correctly:</p>
<div>
<pre>
<code class='bat'>C:\Ruby\DevKit&amp;gt;gem install rdiscount –platform=ruby
<p>Temporarily enhancing <span class="caps">PATH</span> to include DevKit&#8230;<br />
Building native extensions.  This could take a while&#8230;<br />
Successfully installed rdiscount-1.6.8<br />
1 gem installed<br />
Installing ri documentation for rdiscount-1.6.8&#8230;<br />
Installing RDoc documentation for rdiscount-1.6.8&#8230;</code><br />
  </pre></p>
</div>
<p>First command installs RDiscount gem. Argument <code>–platform=ruby</code> tells Rubygems not to look for pre-built binaries for our system, but to install gem from sources. Since RDiscount gem is implemented in C we will need build tools for its installation.</p>
<p>DevKit comes with one more utility script. Batch file devkitvars.bat is used to add patch to DevKit folders at the beginning of the path so we can use build tools from any Command Prompt. Open up new Command Prompt window and execute this batch file.</p>
<div>
<pre>
<code class='bat'>C:\&amp;gt;c:\Ruby\DevKit\devkitvars.bat
<p>Adding the DevKit to <span class="caps">PATH</span>&#8230;</p>
<p>C:\&gt;gcc &#8212;version<br />
gcc (tdm-1) 4.5.0<br />
Copyright &#169; 2010 Free Software Foundation, Inc.<br />
This is free software; see the source for copying conditions.  There is NO<br />
warranty; not even for <span class="caps">MERCHANTABILITY</span> or <span class="caps">FITNESS</span> <span class="caps">FOR</span> A <span class="caps">PARTICULAR</span> <span class="caps">PURPOSE</span>.</code><br />
  </pre></p>
</div>
<p>This batch file is useful if you are developing your own native gems and want to build them without installing. After you execute it you will have complete build tool chain available in the Command Prompt.</p>

      <br/>
      
      <a href="/book/ch02-03.html" title="Previous: Pik">&laquo; Pik</a>
      

      
      &nbsp;&nbsp;&nbsp;|&nbsp;&nbsp;&nbsp;
      <a href="/book/ch02-05.html" title="Next: Installing Native Gems">Installing Native Gems &raquo; </a>
       
    </div>

    <hr>
  </div>
</div>

</body>
</html>
